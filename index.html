<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solution! ‚Äì Student Doubt Solver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-200 via-sky-200 to-emerald-200">

  <!-- Top Bar -->
  <header class="sticky top-0 z-30 bg-white/70 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-xl font-extrabold tracking-tight">üéì Solution! ‚Äì Student Doubt Solver</div>
      <div class="flex items-center gap-3">
        <span id="whoami" class="hidden sm:inline text-sm text-gray-700"></span>
        <button id="logoutBtn" class="hidden px-3 py-1.5 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- AUTH CARD -->
    <section id="authCard" class="max-w-xl mx-auto bg-white rounded-2xl shadow-xl p-6">
      <div class="flex justify-center gap-2 mb-6">
        <button id="tabLogin" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold">Login</button>
        <button id="tabSignup" class="px-4 py-2 rounded-xl bg-gray-200 text-gray-800">Signup</button>
      </div>

      <!-- Login -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="loginEmail" type="email" required class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="you@example.com" />
        </div>
        <div>
          <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
          <input id="loginPassword" type="password" required class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <button class="w-full rounded-xl bg-blue-600 text-white py-2 font-semibold hover:bg-blue-700">Login</button>
      </form>

      <!-- Signup -->
      <form id="signupForm" class="hidden space-y-4">
        <div>
          <label for="signupName" class="block text-sm font-medium text-gray-700">Full name</label>
          <input id="signupName" type="text" class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Student name" />
        </div>
        <div>
          <label for="signupEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="signupEmail" type="email" required class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="you@example.com" />
        </div>
        <div>
          <label for="signupPassword" class="block text-sm font-medium text-gray-700">Password</label>
          <input id="signupPassword" type="password" required class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Minimum 6 characters" />
        </div>
        <button class="w-full rounded-xl bg-green-600 text-white py-2 font-semibold hover:bg-green-700">Create account</button>
      </form>

      <p id="authStatus" class="mt-4 text-center text-sm text-gray-600"></p>

      <div class="mt-6 p-3 border border-amber-400 bg-amber-50 rounded-xl text-sm text-amber-800">
        ‚ö†Ô∏è Add <code class="px-1 bg-white rounded">solutionpanacea.github.io</code> in Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí <b>Authorized domains</b>.
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <!-- Compose + List -->
      <div class="grid md:grid-cols-3 gap-6 mt-4">
        <!-- Post Doubt -->
        <div class="md:col-span-1 bg-white rounded-2xl shadow-xl p-5">
          <h3 class="text-lg font-bold mb-3">Post a doubt</h3>

          <div class="mb-2">
            <label class="block text-sm font-medium">Subject</label>
            <select id="subject" class="mt-1 w-full rounded-xl border px-3 py-2">
              <option>Mathematics</option>
              <option>Science</option>
              <option>English</option>
              <option>Social Studies</option>
              <option>Computer Science</option>
              <option>General</option>
            </select>
          </div>

          <div class="mb-2">
            <label for="title" class="block text-sm font-medium">Title</label>
            <input id="title" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Short title" />
          </div>

          <div class="mb-2">
            <label for="details" class="block text-sm font-medium">Details</label>
            <textarea id="details" class="mt-1 w-full rounded-xl border px-3 py-2" rows="5" placeholder="Describe your doubt"></textarea>
          </div>

          <div class="mb-3">
            <label for="file" class="block text-sm font-medium">Attachment (optional)</label>
            <input id="file" type="file" class="mt-1 w-full rounded-xl border px-3 py-2 bg-gray-50" />
          </div>

          <button id="postBtn" class="w-full rounded-xl bg-blue-600 text-white py-2 font-semibold hover:bg-blue-700">Post Doubt</button>

          <p id="postStatus" class="mt-3 text-sm text-gray-600"></p>
        </div>

        <!-- Doubts List -->
        <div class="md:col-span-2 bg-white rounded-2xl shadow-xl p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">All doubts (realtime)</h3>
            <select id="filterSubject" class="rounded-xl border px-3 py-1.5">
              <option value="All">All subjects</option>
              <option>Mathematics</option>
              <option>Science</option>
              <option>English</option>
              <option>Social Studies</option>
              <option>Computer Science</option>
              <option>General</option>
            </select>
          </div>
          <div id="doubtList" class="space-y-3"></div>
        </div>
      </div>

      <!-- Chat -->
      <div id="chatPanel" class="hidden mt-6 bg-white rounded-2xl shadow-xl p-5">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-bold">üí¨ Chat</h3>
          <button id="closeChat" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300">Close</button>
        </div>
        <div id="chatBox" class="h-64 overflow-y-auto border rounded-xl p-3 bg-gray-50 mb-3"></div>
        <div class="flex gap-2">
          <input id="chatMsg" class="flex-1 rounded-xl border px-3 py-2" placeholder="Type a message‚Ä¶" />
          <input id="chatFile" type="file" class="rounded-xl border px-3 py-2 bg-gray-50" />
          <button id="sendChat" class="rounded-xl bg-blue-600 text-white px-4 py-2 font-semibold hover:bg-blue-700">Send</button>
        </div>
        <p id="chatStatus" class="mt-2 text-sm text-gray-600"></p>
      </div>
    </section>
  </main>

  <!-- Firebase + App Logic -->
  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
      createUserWithEmailAndPassword, updateProfile, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp,
      doc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getStorage, ref, uploadBytes, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // --- CONFIG (correct storage bucket) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD6hPxdAYnaT92xoqfKOnGZhV1AbzBHwyI",
      authDomain: "solution-a0595.firebaseapp.com",
      projectId: "solution-a0595",
      storageBucket: "solution-a0595.appspot.com",
      messagingSenderId: "38814647745",
      appId: "1:38814647745:web:01e1f57baf2ae2a5265b40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- UI Helpers ---
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");
    const toast = (el, msg, ok=false) => {
      el.textContent = msg;
      el.classList.toggle("text-green-700", ok);
      el.classList.toggle("text-rose-700", !ok);
    };
    const displayName = (u) => (u.displayName || (u.email||"").split("@")[0]);

    // --- Tabs ---
    const tabLogin = $("tabLogin");
    const tabSignup = $("tabSignup");
    const loginForm = $("loginForm");
    const signupForm = $("signupForm");
    tabLogin.onclick = () => { tabLogin.className="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold"; tabSignup.className="px-4 py-2 rounded-xl bg-gray-200 text-gray-800"; show(loginForm); hide(signupForm); };
    tabSignup.onclick = () => { tabSignup.className="px-4 py-2 rounded-xl bg-green-600 text-white font-semibold"; tabLogin.className="px-4 py-2 rounded-xl bg-gray-200 text-gray-800"; show(signupForm); hide(loginForm); };

    // --- Auth handlers ---
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        await signInWithEmailAndPassword(auth, $("loginEmail").value.trim(), $("loginPassword").value);
        toast($("authStatus"), "‚úÖ Login successful", true);
      }catch(err){ toast($("authStatus"), "‚ùå "+err.message); }
    });

    $("signupForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        const cred = await createUserWithEmailAndPassword(auth, $("signupEmail").value.trim(), $("signupPassword").value);
        const name = $("signupName").value.trim();
        if(name) await updateProfile(cred.user, { displayName: name });
        toast($("authStatus"), "‚úÖ Account created. You are logged in.", true);
      }catch(err){ toast($("authStatus"), "‚ùå "+err.message); }
    });

    $("logoutBtn").onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, (user)=>{
      if(user){
        hide($("authCard"));
        show($("app"));
        $("whoami").textContent = "Signed in as "+displayName(user);
        show($("whoami"));
        show($("logoutBtn"));
        startDoubtsFeed();
      }else{
        show($("authCard"));
        hide($("app"));
        $("authStatus").textContent = "";
        hide($("logoutBtn"));
        hide($("whoami"));
        stopChatListener();
      }
    });

    // --- Post doubt ---
    $("postBtn").onclick = async ()=>{
      const user = auth.currentUser;
      if(!user) return toast($("postStatus"), "Please login first");
      const subject = $("subject").value;
      const title = $("title").value.trim();
      const details = $("details").value.trim();
      const file = $("file").files[0];
      if(!title || !details) return toast($("postStatus"), "Title and details required");

      try{
        // upload file if present
        let fileURL="", fileName="";
        if(file){
          const path = `doubts/${user.uid}/${Date.now()}_${file.name}`;
          const snap = await uploadBytes(ref(storage, path), file);
          fileURL = await getDownloadURL(snap.ref);
          fileName = file.name;
        }
        await addDoc(collection(db,"doubts"),{
          subject, title, details,
          fileURL, fileName,
          postedBy: displayName(user),
          uid: user.uid,
          created: serverTimestamp(),
          solved: false
        });
        $("title").value=""; $("details").value=""; $("file").value="";
        toast($("postStatus"), "‚úÖ Doubt posted", true);
      }catch(err){ toast($("postStatus"), "‚ùå "+err.message); }
    };

    // --- Realtime doubts feed ---
    let doubtsUnsub = null;
    function startDoubtsFeed(){
      if(doubtsUnsub) doubtsUnsub();
      const q = query(collection(db,"doubts"), orderBy("created","desc"));
      doubtsUnsub = onSnapshot(q, (snap)=>{
        const list = $("doubtList");
        list.innerHTML="";
        const filter = $("filterSubject").value;
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          if(filter!=="All" && d.subject!==filter) return;
          const card = document.createElement("div");
          card.className="p-4 rounded-xl border shadow-sm";
          const fileLink = d.fileURL ? ( /\.(png|jpe?g|gif|webp)$/i.test(d.fileName||"")
            ? `<a href="${d.fileURL}" target="_blank"><img src="${d.fileURL}" class="mt-2 w-40 rounded-lg shadow"></a><div class="text-xs text-gray-500">${d.fileName}</div>`
            : `<a class="text-blue-600 underline" href="${d.fileURL}" target="_blank">üìé ${d.fileName||"Attachment"}</a>` ) : "";
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold text-gray-700 uppercase">${d.subject||""}</div>
              <div class="text-xs text-gray-500">${d.created?.toDate ? d.created.toDate().toLocaleString() : ""}</div>
            </div>
            <div class="mt-1 text-lg font-bold">${d.title||""}</div>
            <div class="mt-1 text-gray-700 whitespace-pre-wrap">${d.details||""}</div>
            ${fileLink?`<div class="mt-2">${fileLink}</div>`:""}
            <div class="mt-2 flex items-center justify-between">
              <div class="text-xs text-gray-500">Posted by: ${d.postedBy||"Student"}</div>
              <div class="flex gap-2">
                ${d.solved
                  ? `<button class="px-3 py-1 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700" data-open="${docSnap.id}">üí¨ Open Chat</button>`
                  : `<button class="px-3 py-1 rounded-lg bg-blue-600 text-white hover:bg-blue-700" data-solved="${docSnap.id}">‚úÖ Mark as solved</button>
                     <button class="px-3 py-1 rounded-lg bg-gray-800 text-white hover:bg-black" data-open="${docSnap.id}">üí¨ Open Chat</button>`
                }
              </div>
            </div>
          `;
          // Wire buttons
          card.querySelectorAll("[data-solved]").forEach(btn=>{
            btn.onclick = async ()=>{ try{ await updateDoc(doc(db,"doubts",btn.dataset.solved), { solved:true }); }catch(e){ alert(e.message); } };
          });
          card.querySelectorAll("[data-open]").forEach(btn=>{
            btn.onclick = ()=> openChat(btn.dataset.open, d.title||"Chat");
          });
          list.appendChild(card);
        });
      });
    }
    $("filterSubject").onchange = startDoubtsFeed;

    // --- Chat (subcollection) ---
    let chatUnsub = null;
    let currentChatId = null;

    function stopChatListener(){ if(chatUnsub) chatUnsub(); chatUnsub=null; }

    function openChat(doubtId, title){
      currentChatId = doubtId;
      stopChatListener();
      $("chatBox").innerHTML="";
      $("chatStatus").textContent="";
      show($("chatPanel"));

      const q = query(collection(db,"doubts",doubtId,"messages"), orderBy("created","asc"));
      chatUnsub = onSnapshot(q, (snap)=>{
        const box = $("chatBox");
        box.innerHTML="";
        snap.forEach(m=>{
          const c = m.data();
          const wrap = document.createElement("div");
          wrap.className="mb-2 rounded-xl bg-gray-100 p-2";
          let fileHtml = "";
          if(c.fileURL){
            fileHtml = (/\.(png|jpe?g|gif|webp)$/i.test(c.fileName||""))
              ? `<div class="mt-1"><a href="${c.fileURL}" target="_blank"><img src="${c.fileURL}" class="w-32 rounded-lg shadow"></a><div class="text-xs text-gray-500">${c.fileName}</div></div>`
              : `<div class="mt-1 text-xs"><a class="text-blue-600 underline" target="_blank" href="${c.fileURL}">üìé ${c.fileName||"attachment"}</a></div>`;
          }
          wrap.innerHTML = `<div class="text-sm font-semibold">${c.name||"Student"}</div><div>${c.message||""}</div>${fileHtml}`;
          box.appendChild(wrap);
        });
        $("chatBox").scrollTop = $("chatBox").scrollHeight;
      });
    }

    $("closeChat").onclick = ()=>{ stopChatListener(); hide($("chatPanel")); currentChatId=null; };

    $("sendChat").onclick = async ()=>{
      const user = auth.currentUser;
      if(!user) return toast($("chatStatus"), "Login required");
      if(!currentChatId) return;

      const msg = $("chatMsg").value.trim();
      const file = $("chatFile").files[0];
      if(!msg && !file) return;

      try{
        let fileURL="", fileName="";
        if(file){
          const path = `chat/${user.uid}/${Date.now()}_${file.name}`;
          const snap = await uploadBytes(ref(storage, path), file);
          fileURL = await getDownloadURL(snap.ref);
          fileName = file.name;
        }
        await addDoc(collection(db,"doubts",currentChatId,"messages"), {
          name: displayName(user),
          uid: user.uid,
          message: msg,
          fileURL, fileName,
          created: serverTimestamp()
        });
        $("chatMsg").value=""; $("chatFile").value="";
        toast($("chatStatus"), "Sent", true);
        setTimeout(()=>$("chatStatus").textContent="", 800);
      }catch(err){ toast($("chatStatus"), "‚ùå "+err.message); }
    };
  </script>

  <!--
  ========================= IMPORTANT FIREBASE RULES =========================
  Firestore (Rules tab):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /doubts/{doubtId} {
        allow read: if true;                 // or request.auth != null
        allow create: if request.auth != null;
        allow update: if request.auth != null;
        // Chat subcollection
        match /messages/{msgId} {
          allow read: if true;
          allow create: if request.auth != null;
        }
      }
    }
  }

  Storage (Rules tab):
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      match /{allPaths=**} {
        allow read: if true;
        allow write: if request.auth != null; // only logged-in users
      }
    }
  }
  =========================================================================== -->
</body>
</html>

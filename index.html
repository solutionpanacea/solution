<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Solution! â€“ Student Doubt Solver</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 via-purple-400 to-indigo-400 p-4">

<div class="max-w-6xl mx-auto space-y-6">

<!-- Header -->
<header class="bg-white/80 backdrop-blur rounded-xl p-4 flex items-center justify-between">
  <div class="text-xl font-bold">ðŸŽ“ Solution! â€“ Student Doubt Solver</div>
  <div class="flex items-center gap-3">
    <span id="whoami" class="hidden text-sm text-gray-700"></span>
    <button id="logoutBtn" class="hidden px-3 py-1 rounded-lg bg-rose-600 text-white">Logout</button>
  </div>
</header>

<!-- Auth Card -->
<section id="authCard" class="bg-white rounded-2xl shadow p-5 max-w-xl mx-auto">
  <div class="flex gap-2 justify-center mb-4">
    <button id="tabLogin" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Login</button>
    <button id="tabSignup" class="px-4 py-2 rounded-xl bg-gray-200">Signup</button>
  </div>

  <form id="loginForm" class="space-y-3">
    <input id="loginEmail" type="email" placeholder="you@example.com" class="w-full rounded-xl border px-3 py-2" />
    <input id="loginPassword" type="password" placeholder="Password" class="w-full rounded-xl border px-3 py-2" />
    <button class="w-full rounded-xl bg-blue-600 text-white py-2">Login</button>
  </form>

  <form id="signupForm" class="hidden space-y-3">
    <input id="signupName" placeholder="Full name" class="w-full rounded-xl border px-3 py-2" />
    <input id="signupEmail" type="email" placeholder="you@example.com" class="w-full rounded-xl border px-3 py-2" />
    <input id="signupPassword" type="password" placeholder="Password" class="w-full rounded-xl border px-3 py-2" />
    <button class="w-full rounded-xl bg-green-600 text-white py-2">Create account</button>
  </form>

  <p id="authStatus" class="text-sm text-center text-gray-600 mt-2"></p>
</section>

<!-- App -->
<section id="app" class="hidden space-y-6">

<div class="grid md:grid-cols-3 gap-6">

  <!-- Compose -->
  <div class="md:col-span-1 bg-white rounded-2xl shadow p-5 space-y-3">
    <h3 class="font-bold text-lg">Post a doubt</h3>

    <label class="block text-sm">Subject</label>
    <select id="subject" class="w-full rounded-xl border px-3 py-2">
      <option>Mathematics</option>
      <option>Science</option>
      <option>English</option>
      <option>Social Studies</option>
      <option>Computer Science</option>
      <option>General</option>
    </select>

    <label class="block text-sm">Title</label>
    <input id="title" class="w-full rounded-xl border px-3 py-2" placeholder="Short title" />

    <label class="block text-sm">Details</label>
    <textarea id="details" rows="4" class="w-full rounded-xl border px-3 py-2" placeholder="Describe your doubt"></textarea>

    <!-- File attachment -->
    <div>
      <label class="block text-sm">Attachment (optional)</label>
      <input id="file" type="file" class="w-full rounded-xl border px-3 py-2 bg-gray-50" />
      <div class="text-xs text-gray-500 mt-1">Note: uploads show progress. Camera snapshots can be OCRed.</div>
    </div>

    <!-- Camera / Multi-page OCR -->
    <div>
      <div class="flex gap-2">
        <button id="startCamera" class="flex-1 rounded-xl bg-indigo-600 text-white py-2">ðŸ“· Open Camera</button>
        <button id="captureSnapshot" class="rounded-xl bg-yellow-500 text-white px-4 py-2 hidden">ðŸ“¸ Capture</button>
      </div>

      <video id="cameraPreview" class="hidden mt-3 w-full rounded-xl border" autoplay playsinline muted></video>
      <canvas id="cameraCanvas" class="hidden"></canvas>

      <div id="pagesArea" class="mt-3 space-y-2 hidden">
        <div class="flex items-center gap-2">
          <div class="flex-1">
            <div id="thumbnails" class="flex gap-2 overflow-x-auto"></div>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="runOcrAll" class="flex-1 rounded-xl bg-purple-600 text-white py-2">Run OCR on all snapshots</button>
          <button id="clearPages" class="rounded-xl bg-gray-200 px-4 py-2">Clear</button>
        </div>
      </div>

      <div class="mt-3">
        <label class="block text-sm">OCR output</label>
        <textarea id="ocrOutput" rows="4" class="w-full rounded-xl border px-3 py-2" placeholder="OCR results will appear here"></textarea>
        <div class="flex items-center gap-2 mt-2">
          <button id="copyOCR" class="rounded-xl bg-green-600 text-white px-4 py-2">Copy</button>
          <div class="flex-1">
            <div id="ocrProgressWrap" class="w-full bg-gray-200 rounded h-3 overflow-hidden hidden">
              <div id="ocrProgress" class="h-3 bg-amber-500 w-0"></div>
            </div>
          </div>
        </div>
        <p id="ocrStatus" class="text-xs text-gray-600 mt-1"></p>
      </div>
    </div>

    <div class="mt-2">
      <div id="uploadProgressWrap" class="w-full bg-gray-200 rounded h-3 overflow-hidden hidden">
        <div id="uploadProgress" class="h-3 bg-blue-600 w-0"></div>
      </div>
      <p id="uploadStatus" class="text-xs text-gray-600 mt-1"></p>
    </div>

    <button id="postBtn" class="w-full rounded-xl bg-blue-600 text-white py-2">Post Doubt</button>
    <p id="postStatus" class="text-sm text-gray-600 mt-2"></p>
  </div>

  <!-- Doubt list -->
  <div class="md:col-span-2 bg-white rounded-2xl shadow p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg">All doubts (realtime)</h3>
      <select id="filterSubject" class="rounded-xl border px-3 py-2">
        <option value="All">All subjects</option>
        <option>Mathematics</option>
        <option>Science</option>
        <option>English</option>
        <option>Social Studies</option>
        <option>Computer Science</option>
        <option>General</option>
      </select>
    </div>
    <div id="doubtList" class="space-y-3"></div>
  </div>
</div>

<!-- Chat -->
<div id="chatPanel" class="hidden bg-white rounded-2xl shadow p-5">
  <div class="flex justify-between items-center mb-2">
    <h4 class="font-semibold">ðŸ’¬ Chat</h4>
    <button id="closeChat" class="rounded bg-gray-200 px-3 py-1">Close</button>
  </div>
  <div id="chatBox" class="h-64 overflow-y-auto border rounded p-3 bg-gray-50 mb-3"></div>
  <div class="flex gap-2">
    <input id="chatMsg" class="flex-1 rounded-xl border px-3 py-2" placeholder="Type a messageâ€¦" />
    <input id="chatFile" type="file" class="rounded-xl border px-3 py-2" />
    <button id="sendChat" class="rounded-xl bg-blue-600 text-white px-4 py-2">Send</button>
  </div>
  <p id="chatStatus" class="text-sm text-gray-600 mt-2"></p>
</div>
</div>

<!-- Firebase + Full Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyD6hPxdAYnaT92xoqfKOnGZhV1AbzBHwyI",
  authDomain: "solution-a0595.firebaseapp.com",
  projectId: "solution-a0595",
  storageBucket: "solution-a0595.appspot.com",
  messagingSenderId: "38814647745",
  appId: "1:38814647745:web:5d58411c5d074e63265b40"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- Auth Handling ---
const authCard = document.getElementById("authCard");
const appSection = document.getElementById("app");
const whoami = document.getElementById("whoami");
const logoutBtn = document.getElementById("logoutBtn");

const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const tabLogin = document.getElementById("tabLogin");
const tabSignup = document.getElementById("tabSignup");
const authStatus = document.getElementById("authStatus");

const loginEmail=document.getElementById("loginEmail");
const loginPassword=document.getElementById("loginPassword");
const signupEmail=document.getElementById("signupEmail");
const signupPassword=document.getElementById("signupPassword");
const signupName=document.getElementById("signupName");

tabLogin.onclick = () => { loginForm.classList.remove("hidden"); signupForm.classList.add("hidden"); tabLogin.classList.add("bg-blue-600","text-white"); tabSignup.classList.remove("bg-blue-600","text-white"); tabSignup.classList.add("bg-gray-200"); };
tabSignup.onclick = () => { signupForm.classList.remove("hidden"); loginForm.classList.add("hidden"); tabSignup.classList.add("bg-green-600","text-white"); tabLogin.classList.remove("bg-blue-600","text-white"); tabLogin.classList.add("bg-gray-200"); };

// Login
loginForm.onsubmit = async e => {
  e.preventDefault();
  authStatus.textContent = "Logging in...";
  try { await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); authStatus.textContent = ""; }
  catch(err){ authStatus.textContent = err.message; }
};

// Signup
signupForm.onsubmit = async e => {
  e.preventDefault();
  authStatus.textContent = "Creating account...";
  try {
    const cred = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
    await updateProfile(cred.user, { displayName: signupName.value });
    authStatus.textContent = "Account created!";
  } catch(err){ authStatus.textContent = err.message; }
};

// Logout
logoutBtn.onclick = async () => { await signOut(auth); };

// --- Auth State ---
onAuthStateChanged(auth, user => {
  if(user){
    authCard.classList.add("hidden"); appSection.classList.remove("hidden");
    whoami.textContent=user.displayName||user.email; whoami.classList.remove("hidden"); logoutBtn.classList.remove("hidden");
    initRealtimeDoubts(); initChatListener();
  } else { authCard.classList.remove("hidden"); appSection.classList.add("hidden"); whoami.classList.add("hidden"); logoutBtn.classList.add("hidden"); }
});

// --- Post Doubt ---
const postBtn = document.getElementById("postBtn");
const uploadProgressWrap = document.getElementById("uploadProgressWrap");
const uploadProgress = document.getElementById("uploadProgress");
const uploadStatus = document.getElementById("uploadStatus");
const fileInput = document.getElementById("file");

postBtn.onclick = async () => {
  const subject=document.getElementById("subject").value;
  const title=document.getElementById("title").value;
  const details=document.getElementById("details").value;
  let fileURL="";
  if(fileInput.files.length>0){
    uploadProgressWrap.classList.remove("hidden");
    const file=fileInput.files[0];
    const storageRef=ref(storage,`attachments/${Date.now()}_${file.name}`);
    const uploadTask=uploadBytesResumable(storageRef,file);
    uploadTask.on("state_changed",snapshot=>{
      const progress=(snapshot.bytesTransferred/snapshot.totalBytes)*100;
      uploadProgress.style.width=progress+"%";
    });
    await new Promise((res,rej)=>uploadTask.then(async snap=>{fileURL=await getDownloadURL(snap.ref); res();}).catch(rej));
    uploadProgressWrap.classList.add("hidden");
  }
  await addDoc(collection(db,"doubts"),{subject,title,details,file:fileURL,uid:auth.currentUser.uid,name:auth.currentUser.displayName||auth.currentUser.email,timestamp:serverTimestamp()});
  document.getElementById("title").value=""; document.getElementById("details").value=""; fileInput.value="";
  uploadStatus.textContent="Posted successfully!";
};

// --- Realtime Doubts ---
const doubtList=document.getElementById("doubtList");
function initRealtimeDoubts(){
  const q=query(collection(db,"doubts"),orderBy("timestamp","desc"));
  onSnapshot(q,snap=>{doubtList.innerHTML=""; snap.forEach(docSnap=>{
    const data=docSnap.data();
    const div=document.createElement("div");
    div.className="border rounded p-3 bg-gray-50";
    div.innerHTML=`<div class="font-bold">${data.title} (${data.subject})</div><div class="text-sm">${data.details}</div>${data.file?`<div><a href="${data.file}" target="_blank" class="text-blue-600 underline">Attachment</a></div>`:""}<div class="text-xs text-gray-600 mt-1">By: ${data.name}</div>`;
    doubtList.appendChild(div);
  });});
}

// --- Chat ---
const chatPanel=document.getElementById("chatPanel");
const chatBox=document.getElementById("chatBox");
const sendChat=document.getElementById("sendChat");
const chatMsg=document.getElementById("chatMsg");
function initChatListener(){ chatPanel.classList.remove("hidden"); const q=query(collection(db,"chat"),orderBy("timestamp","asc")); onSnapshot(q,snap=>{ chatBox.innerHTML=""; snap.forEach(docSnap=>{ const data=docSnap.data(); const div=document.createElement("div"); div.className="mb-1"; div.innerHTML=`<span class="font-bold">${data.name}:</span> ${data.msg}`; chatBox.appendChild(div); }); chatBox.scrollTop=chatBox.scrollHeight;}); }
sendChat.onclick=async()=>{ if(chatMsg.value.trim()==="") return; await addDoc(collection(db,"chat"),{msg:chatMsg.value.trim(),name:auth.currentUser.displayName||auth.currentUser.email,timestamp:serverTimestamp()}); chatMsg.value=""; };

// --- Camera OCR ---
const startCamera=document.getElementById("startCamera");
const captureSnapshot=document.getElementById("captureSnapshot");
const cameraPreview=document.getElementById("cameraPreview");
const cameraCanvas=document.getElementById("cameraCanvas");
const pagesArea=document.getElementById("pagesArea");
const thumbnails=document.getElementById("thumbnails");
const runOcrAll=document.getElementById("runOcrAll");
const clearPages=document.getElementById("clearPages");
const ocrOutput=document.getElementById("ocrOutput");
const ocrProgressWrap=document.getElementById("ocrProgressWrap");
const ocrProgress=document.getElementById("ocrProgress");
const ocrStatus=document.getElementById("ocrStatus");
let cameraStream=null;
let snapshots=[];

startCamera.onclick=async()=>{
  if(navigator.mediaDevices?.getUserMedia){
    cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
    cameraPreview.srcObject=cameraStream; cameraPreview.classList.remove("hidden");
    captureSnapshot.classList.remove("hidden"); pagesArea.classList.remove("hidden");
  } else { alert("Camera not supported"); }
};

captureSnapshot.onclick=()=>{
  const canvas=cameraCanvas; const ctx=canvas.getContext("2d");
  canvas.width=cameraPreview.videoWidth; canvas.height=cameraPreview.videoHeight;
  ctx.drawImage(cameraPreview,0,0,canvas.width,canvas.height);
  const dataUrl=canvas.toDataURL("image/jpeg",0.8);
  snapshots.push(dataUrl);
  const thumb=document.createElement("img");
  thumb.src=dataUrl; thumb.className="h-24 rounded border"; thumbnails.appendChild(thumb);
};

runOcrAll.onclick=async()=>{
  ocrOutput.value=""; ocrProgressWrap.classList.remove("hidden"); ocrProgress.style.width="0%"; ocrStatus.textContent="Processing OCR...";
  for(let i=0;i<snapshots.length;i++){
    const res=await Tesseract.recognize(snapshots[i],"eng",{logger:m=>{ if(m.status==="recognizing text") ocrProgress.style.width=((i+m.progress)/snapshots.length*100)+"%"; }});
    ocrOutput.value+=res.data.text+"\n\n";
  }
  ocrStatus.textContent="OCR Completed"; ocrProgressWrap.classList.add("hidden");
};

clearPages.onclick=()=>{ snapshots=[]; thumbnails.innerHTML=""; ocrOutput.value=""; };

document.getElementById("copyOCR").onclick=()=>{ navigator.clipboard.writeText(ocrOutput.value); };

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solution! - Student Doubt Solver</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6hPxdAYnaT92xoqfKOnGZhV1AbzBHwyI",
  authDomain: "solution-a0595.firebaseapp.com",
  projectId: "solution-a0595",
  storageBucket: "solution-a0595.appspot.com",
  messagingSenderId: "38814647745",
  appId: "1:38814647745:web:01e1f57baf2ae2a5265b40"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let allDoubts = [];

// Register
window.registerUser = async function() {
  const email = document.getElementById("reg-email").value.trim();
  const password = document.getElementById("reg-password").value.trim();
  if (!email || !password) { alert("Enter email and password"); return; }
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    alert("Registration successful! Please log in.");
    document.getElementById("reg-email").value = "";
    document.getElementById("reg-password").value = "";
  } catch (error) { alert("Registration failed: " + error.message); }
};

// Login
window.loginUser = async function() {
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value.trim();
  if (!email || !password) { alert("Enter email and password"); return; }
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    currentUser = userCredential.user;
    document.getElementById("login-section").style.display = "none";
    document.getElementById("main-section").style.display = "block";
    loadDoubts();
    loadSavedDoubts();
  } catch (error) { alert("Login failed: " + error.message); }
};

// Logout
window.logoutUser = async function() {
  await signOut(auth);
  currentUser = null;
  document.getElementById("main-section").style.display = "none";
  document.getElementById("login-section").style.display = "block";
};

// Post doubt with optional file
window.postDoubt = async function() {
  const subject = document.getElementById("subject").value;
  const title = document.getElementById("title").value.trim();
  const details = document.getElementById("details").value.trim();
  const file = document.getElementById("file").files[0];
  let fileURL = "";

  if (!title || !details) { alert("Fill title and details"); return; }

  if (file) {
    if (file.size > 10*1024*1024) { alert("File too large (max 10MB)"); return; }
    const allowedTypes = ["image/jpeg","image/png","application/pdf"];
    if (!allowedTypes.includes(file.type)) { alert("Only JPG, PNG, PDF allowed"); return; }
    const storageRef = ref(storage, "doubts/" + Date.now() + "_" + file.name);
    await uploadBytes(storageRef, file);
    fileURL = await getDownloadURL(storageRef);
  }

  await addDoc(collection(db, "doubts"), { subject, title, details, fileURL, user: currentUser.email, solved: false, created: new Date() });

  document.getElementById("title").value = "";
  document.getElementById("details").value = "";
  document.getElementById("file").value = "";
};

// Load all doubts
function loadDoubts() {
  const q = query(collection(db, "doubts"), orderBy("created","desc"));
  onSnapshot(q, snapshot => {
    allDoubts = [];
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      d.id = docSnap.id;
      allDoubts.push(d);
    });
    displayDoubts(allDoubts);
  });
}

// Display doubts
function displayDoubts(doubtsArray) {
  const list = document.getElementById("doubt-list");
  list.innerHTML = "";
  doubtsArray.forEach(d => {
    const div = document.createElement("div");
    div.className = "doubt-card";
    div.innerHTML = `
      <h3>${d.subject} - ${d.title}</h3>
      <p>${d.details}</p>
      ${d.fileURL ? `<a href="${d.fileURL}" target="_blank">View File</a>` : ""}
      <p><small>Posted by: ${d.user}</small></p>
      ${!d.solved ? `<button onclick="markSolved('${d.id}')">Mark as Solved</button>` : ""}
      ${d.user!==currentUser.email ? `<button onclick="saveDoubt('${d.id}')">Save</button>` : ""}
      <div id="chat-${d.id}" style="margin-top:10px;"></div>
    `;
    list.appendChild(div);
    if(d.solved) loadChat(d.id);
  });
}

// Mark as solved
window.markSolved = async function(doubtId) {
  const doubtRef = doc(db,"doubts",doubtId);
  await updateDoc(doubtRef,{solved:true});
  loadDoubts();
}

// Chat functions
function loadChat(doubtId) {
  const chatContainer = document.getElementById("chat-" + doubtId);
  chatContainer.innerHTML = `
    <div id="messages-${doubtId}" style="max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:5px; margin-bottom:5px;"></div>
    <input type="text" id="chat-input-${doubtId}" placeholder="Type a message..." />
    <input type="file" id="chat-file-${doubtId}" />
    <button onclick="sendChatMessage('${doubtId}')">Send</button>
  `;
  const messagesRef = collection(db,"doubts",doubtId,"chat");
  const q = query(messagesRef, orderBy("created","asc"));
  onSnapshot(q, snapshot => {
    const msgDiv = document.getElementById("messages-"+doubtId);
    msgDiv.innerHTML = "";
    snapshot.forEach(docSnap=>{
      const m=docSnap.data();
      const div = document.createElement("div");
      div.innerHTML = `<strong>${m.user}:</strong> ${m.text||""} ${m.fileURL?`<a href="${m.fileURL}" target="_blank">[File]</a>`:""}`;
      msgDiv.appendChild(div);
    });
    msgDiv.scrollTop = msgDiv.scrollHeight;
  });
}

window.sendChatMessage = async function(doubtId) {
  const textInput = document.getElementById("chat-input-" + doubtId);
  const fileInput = document.getElementById("chat-file-" + doubtId);
  const text = textInput.value.trim();
  let fileURL = "";
  const file = fileInput.files[0];
  if(file){
    const storageRef = ref(storage, `chatFiles/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef,file);
    fileURL = await getDownloadURL(storageRef);
  }
  if(!text && !fileURL) return;
  const chatRef = collection(db,"doubts",doubtId,"chat");
  await addDoc(chatRef,{user:currentUser.email,text:text||"",fileURL:fileURL||"",created:new Date()});
  textInput.value="";
  fileInput.value="";
}

// Filter by subject
window.filterDoubts = function(){
  const selected = document.getElementById("filter-subject").value;
  if(selected==="All") displayDoubts(allDoubts);
  else displayDoubts(allDoubts.filter(d=>d.subject===selected));
}

// Save doubts
window.saveDoubt = async function(doubtId){
  const doubtRef = doc(db,"doubts",doubtId);
  const docSnap = await getDoc(doubtRef);
  if(!docSnap.exists()) return;
  const data = docSnap.data();
  const userSavedRef = doc(db,"users",currentUser.email,"savedDoubts",doubtId);
  await setDoc(userSavedRef,data);
  alert("Doubt saved to your collection!");
  loadSavedDoubts();
}

// Load saved doubts
function loadSavedDoubts(){
  const savedRef = collection(db,"users",currentUser.email,"savedDoubts");
  onSnapshot(savedRef, snapshot=>{
    const list = document.getElementById("saved-list");
    list.innerHTML="";
    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      const div = document.createElement("div");
      div.className="doubt-card";
      div.innerHTML = `
        <h3>${d.subject} - ${d.title}</h3>
        <p>${d.details}</p>
        ${d.fileURL ? `<a href="${d.fileURL}" target="_blank">View File</a>` : ""}
        <p><small>Posted by: ${d.user}</small></p>
      `;
      list.appendChild(div);
    });
  });
}
</script>

<style>
body{font-family:Arial,sans-serif;background:#f0f4f8;margin:0;padding:25px;max-width:800px;margin:auto;}
h2{color:#333;}
input,select,textarea{width:100%;padding:8px;margin:5px 0 15px;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;}
textarea{height:100px;}
.doubt-card{background:#fff;padding:15px;margin:10px 0;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
button{padding:8px 15px;margin-top:5px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
a{color:#007bff;text-decoration:none;}
a:hover{text-decoration:underline;}
</style>
</head>
<body>

<!-- Login/Register Section -->
<div id="login-section">
  <h2>Register</h2>
  <input type="email" id="reg-email" placeholder="Email" /><br>
  <input type="password" id="reg-password" placeholder="Password" /><br>
  <button onclick="registerUser()">Sign Up</button>

  <h2>Login</h2>
  <input type="email" id="login-email" placeholder="Email" /><br>
  <input type="password" id="login-password" placeholder="Password" /><br>
  <button onclick="loginUser()">Login</button>
</div>

<!-- Main Section -->
<div id="main-section" style="display:none;">
  <button onclick="logoutUser()">Logout</button>

  <h2>Post a Doubt</h2>
  <select id="subject">
    <option>Mathematics</option>
    <option>Science</option>
    <option>English</option>
    <option>Social Studies</option>
    <option>Computer Science</option>
    <option>General</option>
  </select><br>
  <input type="text" id="title" placeholder="Title" /><br>
  <textarea id="details" placeholder="Describe the doubt"></textarea><br>
  <input type="file" id="file" /><br>
  <button onclick="postDoubt()">Post Doubt</button>

  <h2>Filter by Subject</h2>
  <select id="filter-subject" onchange="filterDoubts()">
    <option value="All">All Doubts</option>
    <option value="Mathematics">Mathematics</option>
    <option value="Science">Science</option>
    <option value="English">English</option>
    <option value="Social Studies">Social Studies</option>
    <option value="Computer Science">Computer Science</option>
    <option value="General">General</option>
  </select>

  <h2>All Doubts</h2>
  <div id="doubt-list"></div>

  <h2>Saved Doubts</h2>
  <div id="saved-list"></div>
</div>

</body>
</html>
